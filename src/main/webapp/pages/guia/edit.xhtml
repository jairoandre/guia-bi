<ui:composition template="/templates/layout.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                xmlns:guiabi="http://java.sun.com/jsf/composite/guiabi"
                xmlns:uiguiabi="http://vah.com.br/guiabi">

  <ui:define name="metadata">
    <f:metadata>
      <f:viewParam name="id" value="#{guiaController.id}"/>
      <f:viewAction action="#{guiaController.onLoad}"/>
    </f:metadata>
  </ui:define>

  <ui:define name="content">

    <h:form id="form">

      <guiabi:manyToOneDialog id="setorDlg"
                              controller="#{setorController}"
                              header="SELECIONAR SETOR" width="800"
                              update="setor" bean="#{guiaController.item.setor}"/>

      <p:dialog id="atendimentoDlg" widgetVar="atendimentoDlg" modal="true"
                header="SELECIONAR ATENDIMENTO*"
                width="800">
        <p:ajax event="close" process="@this"
                update=":#{p:component('atendimentoPnl')},:#{p:component('pacientePnl')}"/>
        <guiabi:dataTable id="atendimentoDlgTable"
                          controller="#{atendimentoController}" renderAddBtn="false"
                          renderActionColumn="false">
          <p:column style="text-align: center;" width="50">
            <p:commandLink id="radio" ajax="true" styleClass="action-link"
                           process="@this" update="@(.action-link)">
              <f:setPropertyActionListener value="#{item}"
                                           target="#{guiaController.item.atendimento}"/>
              <f:setPropertyActionListener value="#{item.id}"
                                           target="#{guiaController.atendimentoId}"/>
              <h:panelGroup
                styleClass="fa fa#{(guiaController.item.atendimento == null ? false : guiaController.item.atendimento.id == item.id) ? '-dot' : ''}-circle-o"/>
            </p:commandLink>
          </p:column>
          <p:column sortBy="#{item.title}" headerText="Descrição"
                    style="text-align: left;">
            <h:outputText value="#{item.title}"/>
          </p:column>
        </guiabi:dataTable>
        <f:facet name="footer">
          <p:commandButton id="atendimentoDlgCloseBtn" ajax="true"
                           onclick="PF('atendimentoDlg').hide()" value="Fechar diálogo"/>
        </f:facet>
      </p:dialog>

      <h:panelGroup id="guiaPnlWrapper">
        <guiabi:editForm id="guiaForm" controller="#{guiaController}"
                         columns="3">

          <uiguiabi:selectOneEnum id="tipo" label="Tipo" value="#{guiaController.item.tipo}" required="true"
                                  editing="#{guiaController.editing}"
                                  options="#{guiaController.tipos}">
            <p:ajax event="change" listener="#{guiaController.onchangeTipo}" process="@this" update="@form"/>
          </uiguiabi:selectOneEnum>

          <uiguiabi:manyToOne id="setor" dialog="setorDlg" label="Setor" editing="#{guiaController.editing}"
                              title="title" required="true" value="#{guiaController.item.setor}"/>

          <h:panelGroup>
            <p:outputLabel value="Atendimento" for="atendimento" style="font-weight:bold" indicateRequired="false"/>
            <h:outputText value="*" style="font-weight: bold; color: red;"/>
            <h:outputText value=":" style="font-weight: bold;"/>
          </h:panelGroup>

          <h:panelGroup id="atendimentoPnl">

            <p:inputText
              id="atendimento"
              placeholder="Informe o atendimento..."
              styleClass="lance-input"
              value="#{guiaController.atendimentoId}"
              required="true">
              <p:ajax event="change" listener="#{guiaController.searchAtendimento}" process="@this"
                      oncomplete="nextFocus('#{p:component('descricao')}')"
                      update="pacientePnl, atendimentoMsg"/>
            </p:inputText>

            <span/>

            <p:commandButton id="atendimentoOpenDlgBtn"
                             ajax="true"
                             onclick="PF('atendimentoDlg').show()"
                             process="@none"
                             rendered="#{guiaController.editing}"
                             icon="fa fa-search"/>

            <p:commandButton id="atendimentoClearBtn"
                             ajax="true"
                             process="@this"
                             update="atendimentoPnl,pacientePnl"
                             rendered="#{guiaController.editing}"
                             icon="fa fa-trash">
              <f:setPropertyActionListener value="#{null}" target="#{guiaController.item.atendimento}"/>
              <f:setPropertyActionListener value="#{null}" target="#{guiaController.atendimentoId}"/>
            </p:commandButton>

          </h:panelGroup>


          <p:message id="atendimentoMsg" for="atendimento"/>

          <p:outputLabel value="Paciente:" for="paciente" style="font-weight:bold"/>

          <h:panelGroup id="pacientePnl">
            <p:inputText id="pacienteEmpty" value="" placeholder="Nome do paciente..." styleClass="lance-input"
                         readonly="true" rendered="#{guiaController.item.atendimento.paciente == null}"/>
            <p:inputText id="paciente" value="#{guiaController.item.atendimento.paciente.name}" styleClass="lance-input"
                         readonly="true" rendered="#{guiaController.item.atendimento.paciente != null}"/>
          </h:panelGroup>

          <h:panelGroup/>

          <uiguiabi:inputText id="descricao" label="Descrição" value="#{guiaController.item.descricao}"
                              editing="#{guiaController.editing}"/>

          <uiguiabi:inputDate id="data" label="Data da guia" required="true"
                              value="#{guiaController.item.data}" editing="#{guiaController.editing}"
                              readonly="#{guiaController.item.tipo == 'PRORROGACAO'}"/>

          <uiguiabi:inputDate id="dataRecebimento" label="Data de recebimento"
                              value="#{guiaController.item.dataRecebimento}"
                              editing="#{guiaController.editing}"
                              readonly="#{true}"
                              rendered="#{guiaController.item.tipo != null and guiaController.item.tipo != 'PRORROGACAO'}"/>

        </guiabi:editForm>

      </h:panelGroup>
    </h:form>
  </ui:define>
</ui:composition>