<ui:composition template="/templates/layout.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                xmlns:guiabi="http://java.sun.com/jsf/composite/guiabi"
                xmlns:uiguiabi="http://vah.com.br/guiabi">

  <ui:define name="metadata">
    <f:metadata>
      <f:viewParam name="id" value="#{guiaController.id}"/>
      <f:viewAction action="#{guiaController.onLoad}"/>
    </f:metadata>
  </ui:define>

  <ui:define name="content">

    <h:form id="form">

      <h:panelGroup id="guiaPnlWrapper">
        <p:focus context="guiaPnlWrapper"/>
        <guiabi:editForm id="guiaForm" controller="#{guiaController}"
                         columns="3">

          <uiguiabi:selectOneEnum id="tipo" label="Tipo" value="#{guiaController.item.tipo}" required="true"
                                  editing="#{guiaController.editing and guiaController.item.id == null}"
                                  options="#{guiaController.tipos}"
                                  info="#{guiaController.tipoInfo}">
            <p:ajax event="change" listener="#{guiaController.onchangeTipo}" process="@this" update="@form"
                    oncomplete="nextFocus('#{p:component('setor')}')"/>
          </uiguiabi:selectOneEnum>

          <uiguiabi:autoComplete id="especialidade" value="#{guiaController.item.especialidade}" label="Especialidade"
                                 required="true"
                                 controller="#{especialidadeController}" completeMethod="completeEspecialidade"
                                 editing="#{guiaController.editing and guiaController.item.id == null}"
                                 converter="#{especialidadeConverter}" itemLabel="title"
                                 rendered="#{guiaController.item.tipo == 'PARECER'}"
                                 placeholder="Número/Nome especialidade">
            <p:column>
              #{item.id}
            </p:column>
            <p:column>
              #{item.title}
            </p:column>
          </uiguiabi:autoComplete>


          <p:outputLabel value="Procedimentos" for="proFat" styleClass="lance-label"
                         rendered="#{guiaController.item.tipo == 'PROCEDIMENTO'}"/>
          <h:panelGroup rendered="#{guiaController.item.tipo == 'PROCEDIMENTO'}">
            <p:autoComplete id="proFat" value="#{guiaController.proFatToAdd}"
                            widgetVar="proFat"
                            queryDelay="200"
                            var="item"
                            readonly="#{!(guiaController.editing and guiaController.item.id == null)}"
                            itemLabel="#{item['title']}"
                            itemValue="#{item}"
                            converter="#{proFatConverter}"
                            inputStyleClass="lance-input"
                            completeMethod="#{proFatController.completeProFat}"
                            placeholder="Número/Nome procedimento">
              <p:ajax event="itemSelect" listener="#{guiaController.addProFatToList}" process="@this"
                      update="proFatList" oncomplete="$(PF('proFat').jqId + '_input').val('')"/>
              <p:column>
                #{item.idStr}
              </p:column>
              <p:column>
                #{item.title}
              </p:column>
            </p:autoComplete>
            <h:panelGroup id="proFatList" layout="block">
              <ui:repeat value="#{guiaController.item.procedimentos.toArray()}" var="proc">
                <h:panelGroup layout="block" styleClass="list-block">
                  <p:commandLink styleClass="fa fa-close" action="#{guiaController.removeProFat(proc)}"
                                 process="@this" update="#{p:component('proFatList')}"/>
                  <h:outputText value="#{proc.title}"/>
                </h:panelGroup>
              </ui:repeat>
            </h:panelGroup>

          </h:panelGroup>
          <p:message for="proFat" rendered="#{guiaController.item.tipo == 'PROCEDIMENTO'}"/>


          <uiguiabi:autoComplete id="setor" value="#{guiaController.item.setor}" label="Setor" required="true"
                                 controller="#{setorController}" completeMethod="completeSetor"
                                 editing="#{guiaController.editing and guiaController.item.id == null}"
                                 converter="#{setorConverter}" itemLabel="title"
                                 placeholder="Número/Nome setor">
            <p:column>
              #{item.id}
            </p:column>
            <p:column>
              #{item.title}
            </p:column>
          </uiguiabi:autoComplete>

          <uiguiabi:autoComplete id="atendimento" value="#{guiaController.item.atendimento}" label="Atendimento"
                                 required="true"
                                 controller="#{atendimentoController}" completeMethod="completeAtendimento"
                                 editing="#{guiaController.editing and guiaController.item.id == null}"
                                 converter="#{atendimentoConverter}" itemLabel="id"
                                 placeholder="Número/Nome paciente">
            <p:ajax event="itemSelect" update="pacientePnl" oncomplete="nextFocus('#{p:component('descricao')}')"/>
            <p:column>
              #{item.id}
            </p:column>
            <p:column>
              #{item.paciente.name}
            </p:column>
          </uiguiabi:autoComplete>


          <p:outputLabel value="Paciente:" for="paciente" styleClass="lance-label"/>

          <h:panelGroup id="pacientePnl">
            <p:inputText id="pacienteEmpty" value="" placeholder="Nome do paciente..." styleClass="lance-input"
                         readonly="true" rendered="#{guiaController.item.atendimento.paciente == null}"/>
            <p:inputText id="paciente" value="#{guiaController.item.atendimento.paciente.name}" styleClass="lance-input"
                         readonly="true" rendered="#{guiaController.item.atendimento.paciente != null}"/>
          </h:panelGroup>

          <h:panelGroup/>

          <uiguiabi:inputText id="descricao" label="Descrição" value="#{guiaController.item.descricao}"
                              editing="#{guiaController.editing}"/>

          <uiguiabi:inputDate id="data" label="Data da guia" required="true"
                              value="#{guiaController.item.data}"
                              pattern="dd/MM/yyyy HH:mm"
                              editing="#{guiaController.editing and (guiaController.item.tipo != 'PRORROGACAO' or sessionController.isUserInRoles('MANAGER'))}"/>

          <uiguiabi:inputDate id="dataRecebimento" label="Data de recebimento"
                              value="#{guiaController.item.dataRecebimento}"
                              pattern="dd/MM/yyyy HH:mm"
                              editing="#{guiaController.editing and sessionController.isUserInRoles('MANAGER')}"
                              rendered="#{guiaController.item.id != null or guiaController.item.tipo != 'PRORROGACAO'}"/>

          <uiguiabi:inputDate id="dataAuditoria" label="Data de auditoria"
                              value="#{guiaController.item.dataAuditoria}"
                              editing="#{guiaController.editing}"
                              pattern="dd/MM/yyyy HH:mm"
                              rendered="#{guiaController.item.id != null}"/>

          <uiguiabi:inputDate id="dataSolicitacaoConvenio" label="Data de solicitação"
                              value="#{guiaController.item.dataSolicitacaoConvenio}"
                              editing="#{guiaController.editing}"
                              pattern="dd/MM/yyyy HH:mm"
                              rendered="#{guiaController.item.id != null}"/>
                              
        </guiabi:editForm>
      
      	<p:panelGrid id="anexosWrapper">
	      	<p:fileUpload skinSimple="true"
	                        label="Incluir anexo"
	                        uploadLabel="Submeter"
	                        cancelLabel="Cancelar"
	                        onstart="start()"
	                        oncomplete="stop()"
	                        update="anexosWrapper @this"
	                        
	                        fileUploadListener="#{guiaController.uploadAnexo}"/>
	         <h:panelGroup id="anexosWrapper" layout="block" styleClass="margin-top">
	            <ui:repeat value="#{guiaController.item.anexos.toArray()}" var="anexo" varStatus="idx">
	              <h:panelGroup id="anexoItemWrapper" layout="block" styleClass="margin-top">
	                <p:commandButton value="#{anexo.nmAnexo} (#{anexo.tamanhoArquivo} bytes)"
	                                 ajax="false" onclick="PrimeFaces.monitorDownload(start, stop);" immediate="true"
	                                 icon="fa fa-download">
	                  <p:fileDownload value="#{guiaController.download(anexo)}" contentDisposition="attachment"/>
	                </p:commandButton>
	                <p:commandButton icon="fa fa-trash" action="#{guiaController.removerAnexo(anexo)}" ajax="true" process="@this"
	                                 
	                                 update="#{p:component('anexosWrapper')}"
	                                 styleClass="margin-left"/>
	              </h:panelGroup>
	            </ui:repeat>
            </p:panelGrid>
         </h:panelGroup>
      </h:panelGroup>
    </h:form>
  </ui:define>
</ui:composition>